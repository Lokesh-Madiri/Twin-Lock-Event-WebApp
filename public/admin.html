<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TwinLock — Admin Authority Panel</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: #0a0a0a;
            color: #ccc;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            padding: 24px;
        }

        h1 {
            color: #00ccff;
            font-size: 18px;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .subtitle {
            color: #444;
            font-size: 11px;
            margin-bottom: 24px;
        }

        /* Auth */
        #auth-section {
            margin-bottom: 28px;
        }

        input[type=text],
        input[type=password] {
            background: #111;
            border: 1px solid #333;
            color: #ccc;
            padding: 8px 12px;
            font-family: monospace;
            font-size: 12px;
            width: 280px;
            border-radius: 3px;
        }

        input:focus {
            outline: none;
            border-color: #00ccff;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 9px 20px;
            border: 1px solid;
            border-radius: 3px;
            cursor: pointer;
            font-family: monospace;
            font-size: 12px;
            letter-spacing: 1px;
            text-transform: uppercase;
            background: transparent;
            transition: all 0.2s;
            margin: 4px;
        }

        .btn-cyan {
            color: #00ccff;
            border-color: #00ccff;
        }

        .btn-cyan:hover {
            background: rgba(0, 204, 255, 0.1);
        }

        .btn-green {
            color: #00ff41;
            border-color: #00ff41;
        }

        .btn-green:hover {
            background: rgba(0, 255, 65, 0.1);
        }

        .btn-red {
            color: #ff3333;
            border-color: #ff3333;
        }

        .btn-red:hover {
            background: rgba(255, 51, 51, 0.1);
        }

        .btn-amber {
            color: #e09f14;
            border-color: #e09f14;
        }

        .btn-amber:hover {
            background: rgba(224, 159, 20, 0.1);
        }

        /* Panels */
        .panel {
            border: 1px solid #222;
            border-radius: 4px;
            padding: 16px 20px;
            margin-bottom: 20px;
            background: #0d0d0d;
        }

        .panel-title {
            color: #00ccff;
            font-size: 11px;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 14px;
            padding-bottom: 8px;
            border-bottom: 1px solid #1a1a1a;
        }

        /* Status badge */
        #event-status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .badge-active {
            background: rgba(0, 255, 65, 0.1);
            color: #00ff41;
            border: 1px solid #00ff41;
        }

        .badge-inactive {
            background: rgba(255, 51, 51, 0.07);
            color: #ff3333;
            border: 1px solid #ff3333;
        }

        /* Timer */
        #admin-timer {
            font-size: 28px;
            color: #e09f14;
            letter-spacing: 4px;
            margin: 8px 0;
        }

        /* Node table */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            color: #444;
            font-size: 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
            padding: 6px 10px;
            border-bottom: 1px solid #1a1a1a;
        }

        td {
            padding: 8px 10px;
            border-bottom: 1px solid #111;
            font-size: 12px;
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .dot-green {
            background: #00ff41;
            box-shadow: 0 0 4px #00ff41;
        }

        .dot-red {
            background: #ff3333;
            box-shadow: 0 0 4px #ff3333;
        }

        .dot-amber {
            background: #e09f14;
            box-shadow: 0 0 4px #e09f14;
        }

        .dot-grey {
            background: #444;
        }

        /* Log */
        #log {
            max-height: 160px;
            overflow-y: auto;
            font-size: 11px;
            color: #555;
            line-height: 1.7;
        }

        .log-ok {
            color: #00ff41;
        }

        .log-err {
            color: #ff3333;
        }

        .log-warn {
            color: #e09f14;
        }

        .log-info {
            color: #00ccff;
        }

        /* Misc */
        .row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        label {
            color: #555;
            font-size: 11px;
            min-width: 80px;
        }

        .hidden {
            display: none !important;
        }

        #refresh-note {
            color: #333;
            font-size: 10px;
            margin-top: 6px;
        }

        /* Credential Sheet Modal */
        #cred-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 999;
            overflow-y: auto;
            padding: 32px 16px;
        }

        #cred-modal-inner {
            max-width: 860px;
            margin: 0 auto;
            background: #0d0d0d;
            border: 1px solid #00ccff44;
            border-radius: 6px;
            padding: 24px;
        }

        #cred-modal h2 {
            color: #00ccff;
            font-size: 13px;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 16px;
        }

        #cred-table th {
            color: #00ccff;
            font-size: 10px;
        }

        #cred-table td {
            font-size: 12px;
        }

        .key-cell {
            color: #00ff41;
            letter-spacing: 0.15em;
            font-family: monospace;
            font-size: 13px;
        }

        @media print {
            body>*:not(#cred-modal) {
                display: none !important;
            }

            #cred-modal {
                position: static;
                background: white;
            }

            #cred-modal-inner {
                border: none;
            }

            .no-print {
                display: none !important;
            }

            #cred-table td,
            #cred-table th {
                color: #000 !important;
            }

            .key-cell {
                color: #000 !important;
            }
        }
    </style>
</head>

<body>

    <h1>⬡ TwinLock Authority</h1>
    <div class="subtitle">ADMIN CONTROL PANEL — v3.2 — Restricted Access</div>

    <!-- ── Auth ───────────────────────────────── -->
    <div class="panel" id="auth-section">
        <div class="panel-title">Authentication</div>
        <div class="row">
            <label>Backend URL</label>
            <input type="text" id="inp-url" value="http://localhost:8080" />
        </div>
        <div class="row">
            <label>Admin Key</label>
            <input type="password" id="inp-key" placeholder="Enter admin key" />
            <button class="btn btn-cyan" onclick="authenticate()">Connect</button>
        </div>
        <div id="auth-msg" style="color:#555;font-size:11px;margin-top:8px"></div>
    </div>

    <!-- ── Main panel (hidden until authenticated) ── -->
    <div id="main-panel" class="hidden">

        <!-- Event Control -->
        <div class="panel">
            <div class="panel-title">Event Control</div>
            <div class="row">
                <button class="btn btn-green" id="btn-start" onclick="adminAction('start')" disabled
                    style="opacity:0.35">&#9654; Start Event</button>
                <button class="btn btn-red" id="btn-end" onclick="adminAction('end')" disabled
                    style="opacity:0.35">&#9632;
                    End Event</button>
                <button class="btn btn-amber" onclick="loadStatus()">&#8635; Refresh</button>
                <button class="btn btn-cyan" onclick="loadCredentials()">&#128273; Credential Sheet</button>
            </div>
            <div class="row" style="margin-top:4px">
                <div id="player-count-status" style="font-size:11px;color:#555">Checking player count...</div>
            </div>
            <div class="row" style="margin-top:10px">
                <label>Status</label>
                <span id="event-status-badge" class="badge-inactive">INACTIVE</span>
            </div>
            <div id="admin-timer">——:——</div>
            <div id="refresh-note">Auto-refreshes every 3 seconds</div>
        </div>

        <!-- Node Sessions -->
        <div class="panel">
            <div class="panel-title">Node Sessions</div>
            <table>
                <thead>
                    <tr>
                        <th>Team</th>
                        <th>Node</th>
                        <th>Auth</th>
                        <th>Attempts</th>
                        <th>State</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="node-table-body">
                    <tr>
                        <td colspan="6" style="color:#333">No sessions yet.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Activity Log -->
        <div class="panel">
            <div class="panel-title">Activity Log</div>
            <div id="log"></div>
        </div>

    </div>

    <!-- ── Credential Sheet Modal ─────────────────────────── -->
    <div id="cred-modal" onclick="closeCredModal(event)">
        <div id="cred-modal-inner">
            <h2>&#128273; Credential Sheet — All Teams</h2>
            <p style="color:#555;font-size:11px;margin-bottom:16px">
                Distribute each row to the corresponding participant. Keep the keyword/checksum column for organizers
                only.
            </p>
            <div class="row no-print" style="margin-bottom:14px">
                <button class="btn btn-cyan" onclick="window.print()">&#128424; Print</button>
                <button class="btn btn-amber" onclick="copyCredCsv()">&#128203; Copy CSV</button>
                <button class="btn btn-red" style="margin-left:auto"
                    onclick="document.getElementById('cred-modal').style.display='none'">&#10005; Close</button>
            </div>
            <table id="cred-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Team ID</th>
                        <th>Node</th>
                        <th>Access Key</th>
                        <th>Cipher Type</th>
                        <th style="color:#555">Keyword (organizer)</th>
                        <th style="color:#555">Checksum</th>
                    </tr>
                </thead>
                <tbody id="cred-table-body">
                    <tr>
                        <td colspan="7" style="color:#333">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        "use strict";

        var BASE_URL = "";
        var ADMIN_KEY = "";
        var autoRefreshInterval = null;

        function authenticate() {
            BASE_URL = document.getElementById("inp-url").value.trim().replace(/\/$/, "");
            ADMIN_KEY = document.getElementById("inp-key").value.trim();
            if (!ADMIN_KEY) { setAuthMsg("Enter admin key.", "err"); return; }
            loadStatus(function (ok) {
                if (ok) {
                    document.getElementById("auth-section").style.opacity = "0.4";
                    document.getElementById("main-panel").classList.remove("hidden");
                    setAuthMsg("Connected.", "ok");
                    startAutoRefresh();
                } else {
                    setAuthMsg("Authentication failed or backend unreachable.", "err");
                }
            });
        }

        function setAuthMsg(msg, type) {
            var el = document.getElementById("auth-msg");
            el.textContent = msg;
            el.style.color = type === "ok" ? "#00ff41" : type === "err" ? "#ff3333" : "#e09f14";
        }

        function adminAction(action) {
            fetch(BASE_URL + "/api/admin/" + action, {
                method: "POST",
                headers: { "X-Admin-Key": ADMIN_KEY }
            })
                .then(function (r) { return r.json(); })
                .then(function (d) {
                    logEntry(d.status + ": " + (d.message || ""), d.status === "STARTED" ? "ok" : "warn");
                    loadStatus();
                })
                .catch(function () { logEntry("Action failed — backend unreachable.", "err"); });
        }

        function loadStatus(cb) {
            fetch(BASE_URL + "/api/admin/status", {
                headers: { "X-Admin-Key": ADMIN_KEY }
            })
                .then(function (r) {
                    if (r.status === 401) { if (cb) cb(false); return null; }
                    return r.json();
                })
                .then(function (d) {
                    if (!d) return;
                    renderStatus(d);
                    if (cb) cb(true);
                })
                .catch(function () { if (cb) cb(false); });
        }

        function renderStatus(d) {
            // Event status badge
            var badge = document.getElementById("event-status-badge");
            if (d.eventActive) {
                badge.textContent = "ACTIVE";
                badge.className = "badge-active";
            } else {
                badge.textContent = "INACTIVE";
                badge.className = "badge-inactive";
            }

            // Toggle Start / End buttons based on event state + player count
            var btnStart = document.getElementById("btn-start");
            var btnEnd = document.getElementById("btn-end");
            var statusEl = document.getElementById("player-count-status");
            var authCount = (d.nodes || []).filter(function (n) { return n.authenticated; }).length;
            var isEven = authCount >= 2 && authCount % 2 === 0;

            if (btnStart && btnEnd) {
                if (d.eventActive) {
                    // Event running: only End is available
                    btnStart.disabled = true; btnStart.style.opacity = "0.35";
                    btnEnd.disabled = false; btnEnd.style.opacity = "1";
                } else if (isEven) {
                    // Even players ready: both Start available, End locked
                    btnStart.disabled = false; btnStart.style.opacity = "1";
                    btnEnd.disabled = true; btnEnd.style.opacity = "0.35";
                } else {
                    // Odd or zero players: neither available
                    btnStart.disabled = true; btnStart.style.opacity = "0.35";
                    btnEnd.disabled = true; btnEnd.style.opacity = "0.35";
                }
            }
            if (statusEl) {
                if (d.eventActive) {
                    statusEl.textContent = "Event active — " + authCount + " node(s) connected";
                    statusEl.style.color = "#00ff41";
                } else if (authCount === 0) {
                    statusEl.textContent = "No players connected. Waiting for nodes to log in...";
                    statusEl.style.color = "#555";
                } else if (!isEven) {
                    statusEl.textContent = "⚠ " + authCount + " node(s) connected — need even number (paired teams) to start.";
                    statusEl.style.color = "#e09f14";
                } else {
                    statusEl.textContent = "✔ " + authCount + " nodes connected — all paired. Ready to start!";
                    statusEl.style.color = "#00ff41";
                }
            }
            // Timer
            var timerEl = document.getElementById("admin-timer");
            timerEl.textContent = formatTime(d.timeRemainingSeconds || 0);
            timerEl.style.color = (d.timeRemainingSeconds || 0) < 60 ? "#ff3333" : "#e09f14";

            // Node table
            var tbody = document.getElementById("node-table-body");
            if (!d.nodes || d.nodes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="color:#333">No sessions yet.</td></tr>';
                return;
            }
            tbody.innerHTML = d.nodes.map(function (n) {
                var stateDot, stateLabel;
                if (n.unlocked) {
                    stateDot = "dot-green"; stateLabel = "UNLOCKED";
                } else if (n.locked) {
                    stateDot = "dot-red"; stateLabel = "PERM LOCKED";
                } else if (n.authenticated) {
                    stateDot = "dot-amber"; stateLabel = "ACTIVE";
                } else {
                    stateDot = "dot-grey"; stateLabel = "—";
                }
                var attDots = "";
                for (var i = 0; i < 3; i++) {
                    attDots += '<span class="dot ' + (i < n.attemptsUsed ? "dot-red" : "dot-green") + '"></span>';
                }
                return '<tr>' +
                    '<td style="color:#00ccff">' + n.teamId + '</td>' +
                    '<td>' + n.nodeId + '</td>' +
                    '<td>' + (n.authenticated ? '<span style="color:#00ff41">YES</span>' : '<span style="color:#555">NO</span>') + '</td>' +
                    '<td>' + attDots + ' <span style="color:#555">(' + n.attemptsUsed + '/3 used)</span></td>' +
                    '<td><span class="dot ' + stateDot + '"></span>' + stateLabel + '</td>' +
                    '<td><button class="btn btn-amber" style="padding:4px 10px;font-size:10px" onclick="resetNode(\'' + n.teamId + '\',\'' + n.nodeId + '\')">Reset</button></td>' +
                    '</tr>';
            }).join("");
        }

        function resetNode(teamId, nodeId) {
            if (!confirm("Reset node " + teamId + " / " + nodeId + "?")) return;
            fetch(BASE_URL + "/api/admin/reset-node", {
                method: "POST",
                headers: { "X-Admin-Key": ADMIN_KEY, "Content-Type": "application/json" },
                body: JSON.stringify({ teamId: teamId, nodeId: nodeId })
            })
                .then(function (r) { return r.json(); })
                .then(function (d) {
                    logEntry("Node reset: " + d.teamId + " / " + d.nodeId, "warn");
                    loadStatus();
                })
                .catch(function () { logEntry("Reset failed.", "err"); });
        }

        function logEntry(msg, type) {
            var log = document.getElementById("log");
            var ts = new Date().toLocaleTimeString();
            var cls = type === "ok" ? "log-ok" : type === "err" ? "log-err" : type === "warn" ? "log-warn" : "log-info";
            log.innerHTML += '<div class="' + cls + '">[' + ts + '] ' + msg + '</div>';
            log.scrollTop = log.scrollHeight;
        }

        function formatTime(secs) {
            if (!secs || secs <= 0) return "00:00";
            var m = Math.floor(secs / 60);
            var s = Math.floor(secs % 60);
            return (m < 10 ? "0" : "") + m + ":" + (s < 10 ? "0" : "") + s;
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(loadStatus, 3000);
        }

        // ── Credential Sheet ─────────────────────────────────────
        var _credData = [];

        function loadCredentials() {
            document.getElementById('cred-modal').style.display = 'block';
            document.getElementById('cred-table-body').innerHTML =
                '<tr><td colspan="7" style="color:#555">Loading...</td></tr>';
            fetch(BASE_URL + '/api/admin/credentials', {
                headers: { 'X-Admin-Key': ADMIN_KEY }
            })
                .then(function (r) { return r.json(); })
                .then(function (rows) {
                    _credData = rows;
                    var html = rows.map(function (r, i) {
                        return '<tr>' +
                            '<td style="color:#333">' + (i + 1) + '</td>' +
                            '<td style="color:#00ccff;font-weight:bold">' + r.teamId + '</td>' +
                            '<td style="color:#888">' + r.nodeId + '</td>' +
                            '<td class="key-cell">' + r.accessKey + '</td>' +
                            '<td style="color:#e09f14;font-size:11px">' + r.cipher + '</td>' +
                            '<td style="color:#555;font-size:11px">' + r.keyword + '</td>' +
                            '<td style="color:#555;font-size:11px">' + r.checksum + '</td>' +
                            '</tr>';
                    }).join('');
                    document.getElementById('cred-table-body').innerHTML = html;
                    logEntry('Credential sheet loaded — ' + rows.length + ' rows.', 'info');
                })
                .catch(function () {
                    document.getElementById('cred-table-body').innerHTML =
                        '<tr><td colspan="7" style="color:#ff3333">Failed to load. Check connection.</td></tr>';
                });
        }

        function closeCredModal(e) {
            if (e.target === document.getElementById('cred-modal'))
                document.getElementById('cred-modal').style.display = 'none';
        }

        function copyCredCsv() {
            var csv = 'TeamID,NodeID,AccessKey,CipherType,Keyword,Checksum\n';
            csv += _credData.map(function (r) {
                return [r.teamId, r.nodeId, r.accessKey, r.cipher, r.keyword, r.checksum].join(',');
            }).join('\n');
            navigator.clipboard.writeText(csv).then(function () {
                logEntry('CSV copied to clipboard (' + _credData.length + ' rows).', 'ok');
            });
        }
    </script>
</body>

</html>